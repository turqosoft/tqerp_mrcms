<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Insurance Payment Voucher</title>
<style>
  @page {
    size: A4;
    margin: 0.4in; /* safe printable area */
  }

  body {
    font-family: Arial, sans-serif;
    font-size: 12px;
    margin: 0;
    padding: 0;
    color: #000;
  }

  /* Container with 4-side border */
  .container {
    width: 210mm;
    min-height: 297mm;
    padding: 15mm;
    box-sizing: border-box;
    border: 2px solid #000;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }

  h2, h3 {
    text-align: center;
    margin: 5px 0;
  }

  table.main {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    margin-top: 10px;
  }

  table.main th, table.main td {
    border: 1px solid #000;
    padding: 4px;
    text-align: center;
    font-size: 12px;
    word-wrap: break-word;
  }

  table.main th {
    background-color: #f2f2f2;
    font-weight: bold;
  }

  table.main td.amount {
    text-align: right;
  }

  .buyer-section {
    text-align: left;
    padding: 4px;
    font-size: 12px;
  }

  .buyer-section span {
    font-weight: bold;
    font-size: 14px;
  }

  .sign-section {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
  }

  .sign-section div {
    text-align: center;
  }

  /* Print optimization */
  @media print {
    body, .container {
      margin: 0;
      padding: 0;
      width: 210mm;
      height: 297mm;
      border: 2px solid #000;
      box-sizing: border-box;
    }

    table.main {
      page-break-inside: avoid;
    }

    tr {
      page-break-inside: avoid;
      page-break-after: auto;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>PROCEEDINGS OF THE INSURANCE MEDICAL OFFICER E.S.I DISPENSARY</h2>
    <h3>No.1, ERNAKULAM</h3>
    <h3>(Present: Dr Leena J)</h3>
  </div>

{# ----------------- Fetch claim_dates ----------------- #}
{% set table_rows = doc.claim_proceedings if doc.claim_proceedings else [] %}
{% set total_amount = namespace(value=0) %}
{% set claim_dates = [] %}

{% for row in table_rows %}
    {% if row.claim_no %}
        {% set claim_doc = frappe.get_doc("Claim", row.claim_no) %}
        {% if claim_doc.claim_date %}
            {% set claim_dates = claim_dates + [claim_doc.claim_date] %}
        {% endif %}
    {% endif %}
{% endfor %}

{% if claim_dates %}
    {% set earliest_date = claim_dates|min %}
    {% set latest_date = claim_dates|max %}
{% else %}
    {% set earliest_date = None %}
    {% set latest_date = None %}
{% endif %}

<div class="sub-info">
    <p>
        Sub: E.S.I Dispensary No.1, Ernakulam – Medical Reimbursement claims submitted 
        {% if earliest_date and latest_date %}
            from {{ earliest_date }} to {{ latest_date }}
        {% else %}
            (Dates Not Available)
        {% endif %}
        of insured Persons – Sanctioned - orders issued.
    </p>
    <p>Ref: <strong>Order No A-670/2025/ESID No 1/EKM Dated 23/10/2025</strong></p>
    <p>Sanction is hearby accorded to draw and disburse an amount RS.{{total_amount.value}}(Rupees:)to the insured person of this dispensary for their Medical Reimbursement claims submitted from dates to dates vide sub voucher no.{{doc.claim_no}} to {{doc.claim_no}}.The amount may be transffred to the appeded beneficiary accounts</p>
</div>

<table class="main">
  <thead>
    <tr>
      <th style="width:4%;">No</th>
      <th style="width:15%;">Claim No</th>
      <th style="width:25%;">Name</th>
      <th style="width:15%;">IP No</th>
      <th style="width:15%;">Mobile</th>
      <th style="width:15%;">IFSC</th>
      <th style="width:15%;">A/C No</th>
      <th style="width:10%;">Amount</th>
    </tr>
  </thead>
  <tbody>
    {% for row in table_rows %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ row.claim_no or "" }}</td>
      <td>{{ row.name1 or "" }}</td>
      <td>{{ row.ip_no or "" }}</td>
      <td>{{ row.phone or "" }}</td>
      <td>{{ row.ifsc or "" }}</td>
      <td>{{ row.bank_account_no or "" }}</td>
      <td class="amount">
        {% set amt = row.passed_amount or 0 %}
        {{ "{:,.2f}".format(amt) }}
        {% set total_amount.value = total_amount.value + amt %}
      </td>
    </tr>
    {% endfor %}

    <tr>
      <td colspan="7" style="text-align:right; font-weight:bold;">TOTAL</td>
      <td class="amount" style="font-weight:bold;">{{ "{:,.2f}".format(total_amount.value) }}</td>
    </tr>
  </tbody>
</table>

<div class="sign-section">
  <div>
    <p>Verified By</p>
    <br><br>
    <p>Signature & Date</p>
  </div>
  <div>
    <p>Approved By</p>
    <br><br>
    <p>Dr. CINI PRIYA DARSINI V A</p>
    <p>Director of Insurance Medical Services (IIC)</p>
  </div>
</div>

</div> <!-- container end -->

</body>
</html>
